@using ForumAgent.ReadModels
@model ModeratedItems
@{
	ViewBag.Title = "Moderate Posts & Comments";
	var action = (string)ViewContext.Controller.ValueProvider.GetValue("action").RawValue;
	var controller = (string)ViewContext.Controller.ValueProvider.GetValue("controller").RawValue;
	var rejectAction = (ViewBag.ItemType == "posts") ? Url.Action("RejectPost") : Url.Action("RejectComment");
	var approveAction = (ViewBag.ItemType == "posts") ? Url.Action("ApprovePost") : Url.Action("ApproveComment");
}

<script type="text/javascript" src="@Url.Content("~/Content/date.js")"></script>
<script type="text/javascript">
	$(document).ready(function() {
		$($(".moderation-item.unread")[0]).addClass("current-unread");

		$(document).keydown(function(event) {
			var bubble = true;

			var postId = $(".current-unread").attr("data-post-id");

			if (event.which == 40) { // down arrow
				if (!$(".current-unread").length) {

					console.log("loading next page");
					window.location.href = "@Url.Action(action, controller, new { offset = Model.Offset + Model.PageSize, pageSize = Model.PageSize })";
					return false;
				};

				approveItem(postId);
				advanceSelection();

				bubble = false;
			} else if (event.which == 82) { // R (for remove)
				rejectItem(postId);
				advanceSelection();

				bubble = false;
			}

			ensureVisibility();

			return bubble;
		});

		$(".approve").click(function() {
			var postId = $(this).attr("data-post-id");

			if ($(".moderation-item[data-post-id='" + postId + "']").hasClass("moderator-removed")) {
				$(".moderation-item[data-post-id='" + postId + "']").removeClass("moderator-removed");
			}

			approveItem(postId);

			$(".moderation-item.unread[data-post-id='" + postId + "']").removeClass("unread").addClass("read");
			return false;
		});

		$(".reject").click(function() {
			var postId = $(this).attr("data-post-id");

			if ($(".moderation-item[data-post-id='" + postId + "']").hasClass("moderator-approved")) {
				$(".moderation-item[data-post-id='" + postId + "']").removeClass("moderator-approved");
			}

			rejectItem(postId);

			$(".moderation-item[data-post-id='" + postId + "']").removeClass("unread").addClass("read");
			return false;
		});

		$(".tab-selector").click(function() {
			var itemToModerate = $(this).text().toLowerCase();
			window.location.href = "/Moderation/Items/@Model.ForumIdentifier?type=" + itemToModerate;
		});
	});

	function blockUser(userId) {
		$.ajax({
				url: "@Url.Action("PerformBlockOperation", "UserProfile")",
				type: "POST",
				data: { userIdentifier: userId }
			});
	}

	function rejectItem(postId) {
		$.get("@rejectAction", { postId: postId });
		console.log("rejecting item: " + postId);
		updateItem(postId, "moderator-removed", "rejected");
	}

	function approveItem(postId) {
		$.get("@approveAction", { postId: postId });
		console.log("approving item: " + postId);
		updateItem(postId, "moderator-approved", "approved");
	}

	function updateItem(postId, itemClass, text) {
		$(".last-action[data-post-id='" + postId + "']").text(text);
		$(".moderation-item[data-post-id='" + postId + "']").addClass(itemClass);
	}

	function advanceSelection() {
		$(".current-unread").removeClass("unread").removeClass("current-unread").addClass("read");

		$($(".moderation-item.unread")[0]).addClass("current-unread");
	}

	function ensureVisibility() {
		if (!$(".current-unread").length) return;

		var top = parseInt($(".current-unread").position().top);

		if (!$(".current-unread:in-viewport").length) {
			console.log("off the screen");

			$(window).scrollTop(top - 25);
		}
	}
</script>

<div class="article-container">
	<article>
		<header>
			<h2>@ViewBag.Title</h2>
			<nav>
				<ul class="tab-switch">
					<li><a href="#posts" class="tab-selector @if(ViewBag.ItemType == "posts") { <text>default-tab</text> }">Posts</a></li>
					<li><a href="#comments" class="tab-selector  @if(ViewBag.ItemType == "comments") { <text>default-tab</text> }">Comments</a></li>
				</ul>
			</nav>
		</header>
	</article>

	<article>
		<section>
			<p>Press the down arrow to approve and the 'R' key to reject @ViewBag.ItemType</p>
		</section>
	</article>

	<article>
		<section>
			<h3>Latest Activity</h3>

			@if (Model.TotalPosts == 0)
			{
				<p class="no-moderation-items">
					There are no @ViewBag.ItemType to moderate at this time.
				</p>
			}
			else
			{
				<ul class="logs" id="item-list" @if (Model.TotalPosts == 0)
									{<text>style="display:none"</text>}>
					@Html.Partial("_list", Model.Posts)
				</ul>
				@Html.Partial("_pagination")
			}
		</section>
	</article>
</div>

<li id="item-template" data-post-id="" style="display:none">
	<div style="float:left;width:85%">
		<span class="logs-timestamp"></span>
		<h4 class="item-title"></h4>

		<p class="item-body"></p>

		<em class="logs-meta">posted by </em>
	</div>

	<div style="float: left; margin-left: 25px;">
		<a href="#" class="approve" data-post-id=""><img src="@Url.Content("~/Content/thumb-up.png")" alt="approve" rel="tooltip" original-title="Approve this "/></a>
		<br/>
		<a href="#" class="reject" data-post-id=""><img src="@Url.Content("~/Content/thumb-down.png")" alt="reject" rel="tooltip" original-title="Reject this "/></a>
		<br/>
		<a href="#" class="block-user confirmation-dialog" data-confirmation-message="Really Block ?" data-confirm-function="blockUser" data-item-id=""><img src="@Url.Content("~/Content/chromatron/img/icons/icon_table_delete.png")" alt="block author" rel="tooltip" original-title="Block this author"/></a>
		<br/>
		<p style="margin-top: 25px" class="note last-action" data-post-id=""></p>
	</div>
</li>


@section Breadcrumbs {
	<ul id="breadcrumbs">
		<li><a href="/" title="Back to Homepage">Home</a></li>
		<li>@System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(Model.ForumName)</li>
		<li>@ViewBag.Title</li>
	</ul>
}